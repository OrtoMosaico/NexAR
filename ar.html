<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>Visor AR</title>
  
  <script type="module" src="https://unpkg.com/@google/model-viewer@2.1.1/dist/model-viewer.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <style>
    body { margin: 0; padding: 0; font-family: Arial, sans-serif; height: 100vh; display: flex; flex-direction: column; }
    header { background-color: #f8f9fa; padding: 12px; display: flex; align-items: center; gap: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .back-button { background: none; border: none; cursor: pointer; font-size: 16px; color: #0d6efd; display: flex; align-items: center; gap: 8px; }
    .model-name { font-size: 18px; font-weight: bold; flex-grow: 1; margin: 0; }
    model-viewer { width: 100%; height: calc(100vh - 60px); background-color: #f0f0f0; }
    .ar-prompt { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.7); color: white; padding: 10px 15px; border-radius: 20px; font-size: 14px; display: none; z-index: 10; }
    .loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
    .spinner { border: 4px solid rgba(0,0,0,0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #0d6efd; animation: spin 1s linear infinite; margin: 0 auto 10px; }
    .error-message { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #f8d7da; color: #842029; padding: 15px 20px; border-radius: 8px; font-size: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; z-index: 20; max-width: 80%; text-align: center; }
    .controls { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 10; }
    .control-button { width: 50px; height: 50px; border-radius: 50%; background-color: white; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <header>
    <button id="backButton" class="back-button">
      <i class="fas fa-arrow-left"></i> Volver
    </button>
    <h1 id="modelName" class="model-name">Cargando modelo...</h1>
  </header>
  
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div>Cargando modelo 3D...</div>
  </div>
  
  <model-viewer
    id="viewer"
    camera-controls
    auto-rotate
    ar
    ar-modes="webxr scene-viewer quick-look"
    shadow-intensity="1"
    alt="Modelo 3D"
    seamless-poster
    environment-image="neutral"
    exposure="1"
    style="display: none;">
  </model-viewer>
  
  <div id="arPrompt" class="ar-prompt">
    Presiona el botón AR para ver el modelo en realidad aumentada
  </div>
  
  <div id="errorMessage" class="error-message">
    Error al cargar el modelo
  </div>
  
  <div class="controls">
    <button class="control-button" onclick="document.querySelector('model-viewer').toggleAttribute('auto-rotate')">
      <i class="fas fa-sync-alt"></i>
    </button>
    <button class="control-button" onclick="resetCamera()">
      <i class="fas fa-home"></i>
    </button>
  </div>
  
  <script type="module">
    // Importar Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBKzibLWo4MNweXiwr6QoudB9sFb7CeH2w",
      authDomain: "prueba-2-dc1d2.firebaseapp.com",
      projectId: "prueba-2-dc1d2",
      storageBucket: "prueba-2-dc1d2.appspot.com",
      messagingSenderId: "603232032392",
      appId: "1:603232032392:web:575f16d8e613348399313d"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // Función principal
    async function init() {
      try {
        // Obtener ID de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const modelId = urlParams.get('id');
        
        if (!modelId) {
          showDemoModel();
          return;
        }
        
        console.log("Buscando modelo con ID:", modelId);
        
        // Buscar el modelo en la base de datos usando una consulta simplificada
        const linksRef = collection(db, 'short-links');
        const q = query(linksRef, where('modelId', '==', modelId));
        const querySnapshot = await getDocs(q);
        
        if (querySnapshot.empty) {
          // Si no encontramos el modelo, mostrar error
          console.error("Modelo no encontrado");
          showError("Modelo no encontrado");
          showDemoModel();
          return;
        }
        
        // Obtener los datos del primer resultado
        const modelData = querySnapshot.docs[0].data();
        console.log("Modelo encontrado:", modelData);
        
        // Cargar el modelo
        loadModel(modelData.modelUrl, modelData.modelName);
        
      } catch (error) {
        console.error("Error:", error);
        showError(`Error: ${error.message}`);
        showDemoModel();
      }
    }
    
    // Cargar un modelo específico
    function loadModel(modelUrl, modelName) {
      const viewer = document.getElementById('viewer');
      const loading = document.getElementById('loading');
      
      // Configurar título
      document.title = `Visor AR - ${modelName}`;
      document.getElementById('modelName').textContent = modelName;
      
      // Cargar modelo
      viewer.src = modelUrl;
      viewer.alt = modelName;
      
      // Eventos
      viewer.addEventListener('load', () => {
        console.log("Modelo cargado correctamente");
        loading.style.display = 'none';
        viewer.style.display = 'block';
        
        // Mostrar mensaje AR
        document.getElementById('arPrompt').style.display = 'block';
      });
      
      viewer.addEventListener('error', (error) => {
        console.error("Error al cargar el modelo:", error);
        showError("Error al cargar el modelo. Formato incompatible o URL inaccesible.");
        loading.style.display = 'none';
      });
    }
    
    // Mostrar modelo de demostración
    function showDemoModel() {
      const demoUrl = 'https://modelviewer.dev/shared-assets/models/Astronaut.glb';
      loadModel(demoUrl, 'Modelo de demostración');
    }
    
    // Mostrar error
    function showError(message) {
      const errorElement = document.getElementById('errorMessage');
      errorElement.textContent = message;
      errorElement.style.display = 'block';
      document.getElementById('loading').style.display = 'none';
    }
    
    // Función para resetear la cámara
    window.resetCamera = function() {
      const viewer = document.querySelector('model-viewer');
      viewer.cameraOrbit = '0deg 75deg 105%';
      viewer.fieldOfView = '30deg';
    };
    
    // Configurar botón de regreso
    document.getElementById('backButton').addEventListener('click', () => {
      window.history.back();
    });
    
    // Iniciar
    init();
  </script>
</body>
</html> 